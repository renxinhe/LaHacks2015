package com.wynd.grapher;
import java.io.IOException;
import java.util.LinkedList;
import java.util.Properties;

import javax.mail.Message;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class GrapherServlet extends HttpServlet {
	LinkedList<Double> list = new LinkedList<Double>();
	int LIM = 50;
	String[] URLS = {"https://www.eventbrite.com/e/hackathon-at-techcrunch-disrupt-sf-2014-tickets-12058143231",
			"https://www.eventbrite.com/e/kent-hack-enough-tickets-12185923425"};
	public void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
		resp.setContentType("text/plain");
		String action = req.getParameter("action");
		if( action != null){
			if( action.equals("send")){
				list.add(new Double(req.getParameter("data")));
				if( list.size() > LIM)
					list.removeFirst();
				resp.getWriter().println("done");
			}else if( action.equals("get")){
				if( list.isEmpty()) resp.getWriter().println(0);
				else
				resp.getWriter().println(list.getLast());
			}else if( action.equals("check") || action.equals("check2")){
				int x;
				String find, em;
				if( action.equals("check") ){
					x = Integer.parseInt(req.getParameter("id"));
					find = req.getParameter("val");
					em = req.getParameter("email");
				}else{
					x = 0;
					find = "'soldout'";
					em = "wynd07@gmail.com";
				}
				String str = new Fetcher(URLS[x]).fetch();
				if( !str.contains(find)){
					email("Webpage Changed", URLS[x] + " no longer contains " + find, em);
					resp.getOutputStream().println("email sent");
				}else
					resp.getOutputStream().println("no change");
				resp.getOutputStream().println(str);
			}else if( action.equals("tree")){
				String[] ret = new String[1];
				boolean tree = TreeWatch.watch(ret);
				if( tree){
					email("New tree available", "Go check it out", "iwyndwarrior@gmail.com");
					resp.getOutputStream().println("email sent");
				}
				resp.getOutputStream().println(""+tree + "\n\n"+ret[0]);
			}else if( action.equals("testemail")){
				email("New tree available", "Go check it out", "iwyndwarrior@gmail.com");
				resp.getOutputStream().println("email sent");
			}
		}
	}
	
	
	public static void email(String sub, String body, String user){
		Properties props = new Properties();
        Session session = Session.getDefaultInstance(props, null);

        try {
            Message msg = new MimeMessage(session);
            msg.setFrom(new InternetAddress("wynd07@gmail.com", "Andrew Liu"));
            msg.addRecipient(Message.RecipientType.TO,
                             new InternetAddress(user, user));
            msg.setSubject(sub);
            msg.setText(body);
            Transport.send(msg);

        } catch (Exception e){
        	e.printStackTrace();
        }
	}
}
